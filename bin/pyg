#!/usr/bin/env bash
bin="$(dirname $0)"
root="$bin/.."
report="$root/report"

Reset='\033[0m'
BRed='\033[1;31m'
BGreen='\033[1;32m'
Yellow='\033[0;33m'
BYellow='\033[1;33m'
BBlue='\033[1;34m'
IBlack='\033[0;90m'

if ! [ -x "$(command -v pygmentize -V)" ]; then
  echo -e "${BRed}error:${Reset} pygments is not installed. Install with ${BYellow}conda install pygments${Reset}"
  exit 1
fi

# Copy definitions for LaTeX
styles=$(python3 "$bin/pyg_styles")
echo -e "${BBlue}generated: ${IBlack}styles${Reset}"

# Generate syntax highlighting for Crystal files
for file in $(find "$root/src" "$root/spec" \( -name '*.cr' -o -name '*.sh' \) -print)
do
  FILE="${file#$root/}"
  DIR=$(dirname "${FILE}")
  NAME=$(basename "${FILE}" .cr)
  mkdir -p "$report/pyg/$DIR"
  echo "$styles" > "$report/pyg/$DIR/$NAME.tex"
  pygmentize -f latex -O linenos=1,verboptions=numberblanklines=0 "$file" >> "$report/pyg/$DIR/$NAME.tex"
  echo -e "${BGreen}pygmented: ${IBlack}$DIR/${Reset}${Yellow}$NAME.cr${Reset}"
done
